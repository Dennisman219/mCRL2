\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{fullpage}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{booktabs}
\usepackage[dvipsnames]{xcolor}

\newcommand{\vars}{\mathit{vars}}

\title{Quantifier Inside Rewriter}
\author{Jan Friso Groote, Thomas Neele, Wieger Wesselink}

\begin{document}

\maketitle

\[\begin{array}{l}
R_{\exists}(V,\neg \phi)=\neg R_{\forall}(V,\phi),\\
R_{\forall}(V,\bigwedge_i\phi_i) = \exists W.\bigvee_i R_\exists((V \setminus W) \cap \vars(\phi_i), \phi_i),
\text{ where } W = \bigcap_i(\vars(\phi_i)) \\
R_{\exists}(V,\phi\vee \psi)=R_{\exists}(V\cap \vars(\phi),\phi)\vee R_{\exists}(V\cap\vars(\psi),\psi),\\
R_{\exists}(V,\phi\Rightarrow\psi)=
(R_{\forall}((V\cap \vars(\phi)),\phi)\Rightarrow
R_{\exists}((V\cap\vars(\psi)),\psi))\\
R_{\exists}(V,\exists W.\phi)=\exists W.R_{\exists}(V\setminus W,\phi),\\
R_{\exists}(V,\forall W.\phi)=
\left\{\begin{array}{ll}
R_{\exists}(V,\phi)&\textrm{if }W=\emptyset,\\
\exists V.\forall W.\phi&\textrm{otherwise},
\end{array}\right.\\
R_{\exists}(V,\phi)=\exists V\cap\vars(\phi).\phi\textrm{ otherwise}.
\end{array}
\]

We define a rewriter that pushes universal and existential quantifiers into an
expression. A typical example is \[\exists x{:}D.\forall y{:}D'.(X(y,y)\wedge (X(x,y)\vee X(x,x)))\]
which is rewritten to
\[(\forall y{:}D'.X(y,y)\wedge \exists x{:}D.(\forall y{:}D'.X(x,y)\vee X(x,x))).\]
If quantifiers are pushed inside formulas as much as possible, quantifier elimination leads to smaller
expressions and the one-point rewriter is more often applicable. There might be cases where the
application of this push-quantifiers-inside-rewriter can also have averse effects.

Below the definition of the rewrite rules are given. It is assumed that it is cheap to obtain the
free variable in each term, which are denoted by $\vars(\phi)$ for a term $\phi$.
If not, care needs to be taken as in the formulation below calculating the
variables of each term recursively on a by need basis can be very expensive.

Let $\phi$ be a pbes expression. We
define $R(\phi)$ using the functions $R_{\forall}(V,\phi)$ and
$R_{\exists}(V,\phi)$ where $V$ is a set of typed variables. The
definition of $R$ employs the structure of a formula:
\begin{equation*}
\begin{array}{lll}
R(\neg \phi)&=&\neg R(\phi)\\
R(\phi\wedge \psi)&=&R(\phi)\wedge R(\psi)\\
R(\phi\vee\psi)&=&R(\phi)\vee R(\psi)\\
R(\phi\Rightarrow\psi)&=&R(\phi)\Rightarrow R(\psi)\\
R(\forall W.\phi)&=&R_{\forall}(W,R(\phi))\\
R(\exists W.\phi)&=&R_{\exists}(W,R(\phi))\\
R(\phi)&=&\phi\textrm{  otherwise}.
\end{array}
\end{equation*}
Here $W$ is a set of typed variables.

The rewrite function $R_{\forall}$ is defined by

\begin{equation*}
\begin{array}{lll}
R_{\forall}(V,\neg \phi) &=& \neg R_{\exists}(V,\phi)\\

R_{\forall}(V,\phi\wedge \psi)&=&R_{\forall}(V,\phi)\wedge R_{\forall}(V,\psi)\\

R_{\forall}(V, \bigvee_i \phi_i)&=&
  \forall W.
    \left(
         R_\forall(V \setminus W, \bigvee_{i \in I_1}\phi_i) \lor \bigvee_{i \in I_2}R(\phi_i)
    \right) \\
  && \text{where } W = \vars(\phi_j) \cap V \text{ for some $j$ such that $|W|$ is minimal,} \\
  && \text{and where } I_1 = \{ i \mid \vars(\phi_i) \cap V \nsubseteq W \}, I_2 = \{ i \mid \vars(\phi_i) \cap V \subseteq W \} \\

R_{\forall}(V,\phi\Rightarrow\psi)&=&\forall (V\cap\vars(\phi)\cap\vars(\psi)).
(R_{\exists}((V\cap \vars(\phi))\setminus \vars(\psi),\phi)\Rightarrow{} \\
&& R_{\forall}((V\cap\vars(\psi))\setminus\vars(\phi),\psi))\\

R_{\forall}(V,\forall W.\phi)&=&\forall W.R_{\forall}(V\setminus W,\phi)\\

R_{\forall}(V,\exists W.\phi)&=&
\left\{\begin{array}{ll}
R_{\forall}(V,\phi)&\textrm{if }W=\emptyset\\
\forall V.\exists W.\phi&\textrm{otherwise}
\end{array}\right.\\

R_{\forall}(V,\phi)&=&\forall V\cap \vars(\phi).\phi\textrm{ otherwise}.

\end{array}
\end{equation*}

The rewrite function $R_{\exists}$ is defined by
\begin{equation*}
\begin{array}{lll}
R_{\exists}(V,\neg \phi)&=&\neg R_{\forall}(V,\phi)\\

R_{\exists}(V, \bigwedge_i \phi_i)&=&
  \exists W.
    \left(
         R_\exists(V \setminus W, \bigvee_{i \in I_1}\phi_i) \lor \bigvee_{i \in I_2}R(\phi_i)
    \right) \\
  && \text{where } W = \vars(\phi_j) \cap V \text{ for some $j$ such that $|W|$ is minimal,} \\
  && \text{and where } I_1 = \{ i \mid \vars(\phi_i) \cap V \nsubseteq W \}, I_2 = \{ i \mid \vars(\phi_i) \cap V \subseteq W \} \\

R_{\exists}(V,\phi\vee \psi)&=&R_{\exists}(V,\phi)\vee R_{\exists}(V,\psi)\\

R_{\exists}(V,\phi\Rightarrow\psi)&=&
(R_{\forall}((V\cap \vars(\phi)),\phi)\Rightarrow
R_{\exists}((V\cap\vars(\psi)),\psi))\\

R_{\exists}(V,\exists W.\phi)&=&\exists W.R_{\exists}(V\setminus W,\phi)\\

R_{\exists}(V,\forall W.\phi)&=&
\left\{\begin{array}{ll}
R_{\exists}(V,\phi)&\textrm{if }W=\emptyset\\
\exists V.\forall W.\phi&\textrm{otherwise}
\end{array}\right.\\

R_{\exists}(V,\phi)&=&\exists V\cap\vars(\phi).\phi\textrm{ otherwise}.
\end{array}
\end{equation*}

\end{document}
